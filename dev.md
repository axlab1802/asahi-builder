# 未来の旭市ビルダー - 開発ドキュメント

## プロジェクト概要

千葉県旭市の未来を描く対話型都市計画シミュレーションゲーム。
Google Gemini 2.5 Flash APIを活用し、ユーザーとAIが協力して理想の街づくりを行う。

**技術スタック:**
- フロントエンド: React 19.2.4 + TypeScript
- ビルドツール: Vite 6.4.1
- AI: Google Gemini 2.5 Flash (@google/genai v1.41.0)
- 地図: Leaflet 1.9.4
- スタイリング: Tailwind CSS (CDN)

## 開発経過

### Phase 1: 基本実装
- ✅ React + TypeScript + Viteのセットアップ
- ✅ Leafletを使用した地図表示機能
- ✅ Gemini APIとの統合
- ✅ チャットインターフェース実装
- ✅ 施設追加・削除・更新機能
- ✅ 人口・税収の計算とリアルタイム表示

### Phase 2: ゲーム性の追加
- ✅ ターン制限（5回まで施設追加可能）
- ✅ 人口100万人を目標とした進捗バー
- ✅ ハイスコア機能（LocalStorage）
- ✅ リザルトモーダル
- ✅ 地図エクスポート機能（PNG）

### Phase 3: UI/UX改善
- ✅ 通常地図・設計図の2つの表示モード
- ✅ 人口増減のアニメーション表示
- ✅ レスポンシブデザイン（モバイル対応）
- ✅ グラデーション・シャドウを使った現代的なUI

### Phase 4: 都市比較機能（2026/02/17実装）
- ✅ 世界の主要都市データベース作成（42都市）
- ✅ 人口規模が近い都市の自動表示
- ✅ 税収規模が近い都市の自動表示
- ✅ プログレスバーによる達成率可視化
- ✅ リアルタイム比較更新
- ✅ 同規模都市の追加（千葉県内の市町村）

### Phase 5: データ正確性の向上（2026/02/17実装）
- ✅ 旭市の実人口データへの更新（59,948人、2026年1月1日現在）
- ✅ 実税収データへの更新（220億円、令和6年度一般会計予算）
- ✅ 比較対象都市の最適化（同規模の都市を優先表示）

### Phase 6: 環境変数の修正（2026/02/17実装）
- ✅ Vite環境変数への対応（`VITE_API_KEY`）
- ✅ TypeScript型定義の追加（`vite-env.d.ts`）
- ✅ `import.meta.env`への移行

## 現在の課題

### 技術的課題
1. **バンドルサイズ**
   - 現在839KB（gzip: 217KB）
   - Leafletとその依存関係が大きい
   - 動的インポートによるコード分割が必要

2. **型安全性**
   - Gemini APIのレスポンス型が`any`
   - より厳密な型定義が望ましい

3. **エラーハンドリング**
   - API呼び出し失敗時の詳細なエラー表示が不足
   - リトライ機構がない

4. **パフォーマンス**
   - 地図の再レンダリング最適化の余地あり
   - useMemoの活用をさらに進められる

### UX課題
1. **チュートリアル不足**
   - 初回プレイ時のガイドがない
   - ゲームルールの説明が不十分

2. **フィードバック**
   - 施設追加時のアニメーションが控えめ
   - 達成感を高める演出が必要

3. **アクセシビリティ**
   - キーボード操作のサポートが不完全
   - スクリーンリーダー対応が未実装

## 将来実装すると面白そうな機能

### 短期（1-2週間で実装可能）
1. **チュートリアルモード**
   - 初回プレイ時のステップバイステップガイド
   - サンプル施設の提案

2. **施設カテゴリフィルター**
   - 地図上の施設を種類別に表示/非表示
   - アイコンの色分け強化

3. **統計ダッシュボード**
   - 施設タイプ別の人口・税収貢献度グラフ
   - 時系列での変化を可視化

4. **SNSシェア機能**
   - 完成した地図をTwitter/Facebookでシェア
   - OGP画像の自動生成

5. **サウンドエフェクト**
   - 施設追加時の効果音
   - BGM（ON/OFF切り替え可能）

### 中期（1-2ヶ月で実装可能）
1. **マルチプレイヤーモード**
   - 複数ユーザーで協力して街づくり
   - WebSocketによるリアルタイム同期
   - チャット機能

2. **シナリオモード**
   - 「観光都市を目指せ」「工業都市を目指せ」などのテーマ
   - 各シナリオ専用の施設・イベント
   - 達成条件とランキング

3. **季節・時間の概念**
   - 春夏秋冬で地図の見た目が変化
   - 昼夜のサイクル
   - 季節イベント（桜祭り、花火大会など）

4. **災害イベント**
   - 台風、地震などのランダムイベント
   - 防災施設の重要性
   - 復興フェーズ

5. **経済シミュレーション**
   - より詳細な税収計算（固定資産税、法人税など）
   - 維持費の概念
   - 予算配分の戦略性

6. **3D地図モード**
   - Three.jsを使った3D表示
   - 建物の高さ表現
   - カメラアングルの自由度

### 長期（3ヶ月以上）
1. **AI市長システム**
   - Geminiが市長として政策提案
   - 市民の声（AIが生成）への対応
   - 議会システム

2. **歴史モード**
   - 実際の旭市の歴史を追体験
   - 過去の写真・資料の統合
   - タイムトラベル機能

3. **VR/AR対応**
   - VRヘッドセットで街を歩く
   - ARで実際の旭市に未来の建物を重ねる
   - 没入感のある体験

4. **教育コンテンツ化**
   - 学校での都市計画教育に活用
   - 先生用の管理画面
   - 生徒の作品ギャラリー

5. **実際の行政との連携**
   - 市民の意見収集ツールとして活用
   - 実際の都市計画への反映
   - オープンデータとの統合

6. **モバイルアプリ化**
   - React Nativeでのネイティブアプリ
   - オフライン対応
   - プッシュ通知（イベント告知など）

## 技術的改善案

### コード品質
- [ ] ESLint + Prettierの導入
- [ ] Huskyでのpre-commitフック
- [ ] 単体テスト（Vitest）
- [ ] E2Eテスト（Playwright）
- [ ] Storybookでのコンポーネントカタログ

### パフォーマンス
- [ ] React.memoの活用
- [ ] 仮想スクロール（施設リストが増えた場合）
- [ ] Service Workerでのキャッシング
- [ ] CDNの活用

### セキュリティ
- [ ] APIキーの適切な管理（環境変数）
- [ ] レート制限の実装
- [ ] XSS対策の強化
- [ ] CSP（Content Security Policy）の設定

### 開発体験
- [ ] GitHub Actionsでの自動デプロイ
- [ ] プレビュー環境の自動生成
- [ ] 開発用のモックAPIサーバー
- [ ] ドキュメント自動生成

## 参考リンク

- [旭市公式サイト](https://www.city.asahi.lg.jp/)
- [Google Gemini API](https://ai.google.dev/)
- [Leaflet Documentation](https://leafletjs.com/)
- [React Documentation](https://react.dev/)

## ライセンス

このプロジェクトは個人開発プロジェクトです。

---

**最終更新:** 2026年2月18日  
**開発者:** @axlab1802
